import sqlite3
import os
import tkinter as tk
from tkinter import scrolledtext
import threading
import time

# ì¹´ì¹´ì˜¤í†¡ ë°ì´í„°ë² ì´ìŠ¤ ê²½ë¡œ (ì‚¬ìš©ìë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
KAKAO_DB_PATH = os.path.expanduser(r'~\AppData\Local\Kakao\KakaoTalk\KakaoTalk.db')

class KakaoReaderApp:
    def __init__(self, root):
        self.root = root
        self.root.title("ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ ë·°ì–´")
        self.root.geometry("600x400")

        self.text_area = scrolledtext.ScrolledText(root, wrap=tk.WORD, width=70, height=20, font=("Arial", 10))
        self.text_area.pack(pady=10)

        self.refresh_button = tk.Button(root, text="ë©”ì‹œì§€ ì—…ë°ì´íŠ¸", command=self.update_messages)
        self.refresh_button.pack()

        self.running = True
        self.thread = threading.Thread(target=self.auto_update, daemon=True)
        self.thread.start()

    def get_latest_kakao_message(self):
        """ì¹´ì¹´ì˜¤í†¡ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìµœê·¼ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜´"""
        if not os.path.exists(KAKAO_DB_PATH):
            return "âŒ ì¹´ì¹´ì˜¤í†¡ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

        try:
            conn = sqlite3.connect(KAKAO_DB_PATH)
            cursor = conn.cursor()

            # ê°€ì¥ ìµœê·¼ 5ê°œ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
            cursor.execute("SELECT chat_id, user_id, message, created_at FROM chat_messages ORDER BY created_at DESC LIMIT 5")
            messages = cursor.fetchall()

            conn.close()

            result = "\n".join([f"ğŸ“© {chat[1]}: {chat[2]} (ì‹œê°„: {chat[3]})" for chat in messages])
            return result

        except Exception as e:
            return f"âš ï¸ ì˜¤ë¥˜ ë°œìƒ: {e}"

    def update_messages(self):
        """ë©”ì‹œì§€ë¥¼ GUI ì°½ì— ì—…ë°ì´íŠ¸"""
        new_messages = self.get_latest_kakao_message()
        self.text_area.delete(1.0, tk.END)
        self.text_area.insert(tk.END, new_messages)

    def auto_update(self):
        """5ì´ˆë§ˆë‹¤ ìë™ìœ¼ë¡œ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸"""
        while self.running:
            self.update_messages()
            time.sleep(5)

    def on_close(self):
        """í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ ìŠ¤ë ˆë“œ ì •ë¦¬"""
        self.running = False
        self.root.quit()

if __name__ == "__main__":
    root = tk.Tk()
    app = KakaoReaderApp(root)
    root.protocol("WM_DELETE_WINDOW", app.on_close)
    root.mainloop()
